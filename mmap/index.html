<!DOCTYPE html>

<html>
<head>
<link rel="stylesheet" href="style.css" type="text/css">
<script type="text/javascript"
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCBXytsTGPDgxCcgRFdOuLLj7yh2jInP40">
</script>
<script>
var map = null;
var overlay = document.getElementById("over_map");
var position =  {coords:{latitude:0.0, longitude:0.0}};
var names = {"nr":"Norman Ramsey", "snape":"Professor Severus Snape", 
    "carmen":"Carmen", "waldo":"Waldo", "hescott":"Professor Ben Hescott",
    "batman":"Batman"
};

navigator.geolocation.getCurrentPosition(function (pos) { position = pos;});
//both pos1 and pos2 are expected as JSON of the form {lat:*latitude*, lng:*longitude*
function distance(pos1, pos2) {

}
function initialize() {
    var mapOptions = {
center: { lat: position.coords.latitude,lng:position.coords.longitude },
        zoom: 16
    };
    map = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);
    google.maps.event.addListenerOnce(map, 'idle', function(){
            xhr.send("login=PeterGriffin&lat="+position.coords.latitude+"&lng="+position.coords.longitude);
            });
}
var xhr = new XMLHttpRequest();
xhr.open("POST", "http://chickenofthesea.herokuapp.com/sendLocation");
xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

xhr.onreadystatechange = function () {
    if (xhr.readyState == 4 && xhr.status == 200) {

        people = JSON.parse(xhr.responseText);

        people.characters.map(function(person) {
                var marker = new google.maps.Marker({map:map, 
                    position:{lat:person.loc.latitude, lng:person.loc.longitude}, 
                    icon:person.name+'.png'}) 
                var infoWindow = new google.maps.InfoWindow(
                    {content:"<h1>"+names[person.name]+"</h1>",disableAutoPan:true});
                var points = [
                new google.maps.LatLng(position.coords.latitude, position.coords.longitude),
                new google.maps.LatLng(person.loc.latitude, person.loc.longitude)];
                var polyLine = new google.maps.Polyline({path:points,
                    geodesic : true,
                    strokeColor : 0x0000FF,
                    strokeOpacity : 2});
                polyLine.setMap(map);
                infoWindow.open(map, marker);
                return null;
                });

        people.students.map(function(person) {
                var marker = new google.maps.Marker({map:map, 
                    position:{lat:person.lat, lng:person.lng}, 
                    icon:google.maps.CIRCLE});
                var infoWindow = new google.maps.InfoWindow(
                    {content:"<h1>"+person.login+"</h1>", disableAutoPan:true});
                infoWindow.open(map, marker);
                return null;
                });

        position = {coords:{latitude:0.0, longitude:0.0}};
        //map.center=position.coords;
        var marker = new google.maps.Marker({map:map, 
                position:{lat:position.coords.latitude, 
                lng:position.coords.longitude}, icon:google.maps.blu_circle});
    }
}
google.maps.event.addDomListener(window, 'load', initialize);
</script>
</head>
<body>
<div id="map-canvas"></div>
<div id="over_map"></div>
</body>
</html>
